\newpage
\begin{center}
\textbf{
\MakeUppercase{Приложение А}\\
(обязательное) \\Листинг программы
}
\end{center}
\addcontentsline{toc}{section}{Приложение А (обязательное) Листинг программы}

\begin{lstlisting}[style=stp-lang]
package su.kawunprint.data.repository

import org.jetbrains.exposed.sql.*
import org.jetbrains.exposed.sql.SqlExpressionBuilder.eq
import su.kawunprint.data.model.FilamentTypeModel
import su.kawunprint.data.model.tables.FilamentTypeTable
import su.kawunprint.domain.repository.FilamentTypeRepository
import su.kawunprint.plugins.Databases.dbQuery

class FilamentTypeRepositoryImpl : FilamentTypeRepository {

    override suspend fun getAllFilamentTypes(): List<FilamentTypeModel> {
        return dbQuery {
            FilamentTypeTable.selectAll().map { rowToModel(it) }
        }
    }

    override suspend fun createFilamentType(type: FilamentTypeModel) {
        dbQuery {
            FilamentTypeTable.insert { table ->
                table[name] = type.name
                table[description] = type.description
            }
        }
    }

    override suspend fun deleteFilamentType(type: FilamentTypeModel) {
        dbQuery {
            FilamentTypeTable.deleteWhere { FilamentTypeTable.id eq type.id }
        }
    }


    override suspend fun updateFilamentType(type: FilamentTypeModel) {
        dbQuery {
            FilamentTypeTable.update({ FilamentTypeTable.id eq type.id }) { table ->
                table[name] = type.name
                table[description] = type.description
            }
        }
    }

    override suspend fun getFilamentTypeById(id: Int): FilamentTypeModel? {
        return dbQuery {
            FilamentTypeTable.select { FilamentTypeTable.id eq id }.map { rowToModel(it) }.singleOrNull()
        }
    }

    private fun rowToModel(row: ResultRow): FilamentTypeModel {
        return FilamentTypeModel(
            id = row[FilamentTypeTable.id],
            name = row[FilamentTypeTable.name],
            description = row[FilamentTypeTable.description]
        )
    }
}

package data.repository

import data.model.OrderFileModel
import domain.repository.OrderFileRepository
import org.jetbrains.exposed.sql.*
import org.jetbrains.exposed.sql.SqlExpressionBuilder.eq
import su.kawunprint.data.model.tables.OrderFileTable
import su.kawunprint.plugins.Databases.dbQuery

class OrderFileRepositoryImpl : OrderFileRepository {

    override suspend fun saveFileMetadata(file: OrderFileModel): OrderFileModel? {
        val key = dbQuery {
            OrderFileTable.insert {
                it[orderId] = file.orderId
                it[fileName] = file.fileName
                it[fileUrl] = file.fileUrl
                it[firebaseStoragePath] = file.firebaseStoragePath
                it[fileSize] = file.fileSize
                it[mimeType] = file.mimeType
                it[uploadedAt] = file.uploadedAt
                it[uploadedBy] = file.uploadedBy
            }.resultedValues?.firstOrNull()?.get(OrderFileTable.id)
        }
        return key?.let { getFileById(it) }
    }

    override suspend fun getFilesByOrderId(orderId: Int): List<OrderFileModel> {
        return dbQuery {
            OrderFileTable.select { OrderFileTable.orderId eq orderId }
                .orderBy(OrderFileTable.uploadedAt, SortOrder.DESC)
                .map { rowToModel(it) }
        }
    }

    override suspend fun getFileById(fileId: Int): OrderFileModel? {
        return dbQuery {
            OrderFileTable.select { OrderFileTable.id eq fileId }
                .map { rowToModel(it) }
                .singleOrNull()
        }
    }

    override suspend fun deleteFile(fileId: Int): Boolean {
        return dbQuery {
            OrderFileTable.deleteWhere { OrderFileTable.id eq fileId } > 0
        }
    }

    override suspend fun deleteFilesByOrderId(orderId: Int): Boolean {
        return dbQuery {
            OrderFileTable.deleteWhere { OrderFileTable.orderId eq orderId } > 0
        }
    }

    override suspend fun countFilesByOrderId(orderId: Int): Int {
        return dbQuery {
            OrderFileTable.select { OrderFileTable.orderId eq orderId }
                .count()
                .toInt()
        }
    }

    private fun rowToModel(row: ResultRow): OrderFileModel {
        return OrderFileModel(
            id = row[OrderFileTable.id],
            orderId = row[OrderFileTable.orderId],
            fileName = row[OrderFileTable.fileName],
            fileUrl = row[OrderFileTable.fileUrl],
            firebaseStoragePath = row[OrderFileTable.firebaseStoragePath],
            fileSize = row[OrderFileTable.fileSize],
            mimeType = row[OrderFileTable.mimeType],
            uploadedAt = row[OrderFileTable.uploadedAt],
            uploadedBy = row[OrderFileTable.uploadedBy]
        )
    }
}
\end{lstlisting}